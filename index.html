<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>wplace æŠ˜ã‚Œç‚¹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>

  <!-- ===== å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
  <header class="app-header">
    <div class="header-inner">
      <h1>wplace æŠ˜ã‚Œç‚¹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
    </div>
  </header>

  <!-- ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== -->
  <main class="app-main">
    <div class="container">

      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <form id="plan-form" class="card">
        <div class="field">
          <label for="startUrlInput">å§‹ç‚¹URL</label>
          <input id="startUrlInput" name="startUrl" type="url"
                 placeholder="https://wplace.live/?lat=...&lng=...&zoom=..." required />
        </div>

        <div class="field">
          <label for="endUrlInput">çµ‚ç‚¹äºˆå®šåœ°URL</label>
          <input id="endUrlInput" name="endUrl" type="url"
                 placeholder="https://wplace.live/?lat=...&lng=...&zoom=..." required />
        </div>

        <div class="row">
          <div class="field">
            <label for="order">æŠ˜ã‚‹é †åº</label>
            <select id="order" name="order">
              <option value="auto" selected>è‡ªå‹•ï¼ˆèª¤å·®ãŒå°ã•ã„æ–¹ï¼‰</option>
              <option value="a-first">å§‹ç‚¹å´ã®å‚¾ãã‚’ç·©ã‚„ã‹ã«ã™ã‚‹</option>
              <option value="b-first">å§‹ç‚¹å´ã®å‚¾ãã‚’æ€¥ã«ã™ã‚‹</option>
            </select>
          </div>
        </div>

        <button type="submit" class="primary">è¨ˆç®—ã™ã‚‹</button>
        <p class="note">â€»URLã® <code>lat</code> ã¨ <code>lng</code> ã®ã¿å‚ç…§ã—ã¾ã™ã€‚</p>
      </form>

      <!-- çµæœè¡¨ç¤º -->
      <section id="result" class="card" hidden>
        <h2>çµæœ</h2>

        <div class="result-grid">
          <!-- å§‹ç‚¹ -->
          <div class="box">
            <h3>å§‹ç‚¹ï¼š[ãƒãƒ£ãƒ³ã‚¯]ï¼ˆåº§æ¨™ï¼‰</h3>
            <pre id="startLocal"></pre>
          </div>

          <!-- å§‹ç‚¹å´ å‚¾ã -->
          <div class="box">
            <h3>å§‹ç‚¹å´ã®å‚¾ã</h3>
            <pre id="slopeStart"></pre>
          </div>

          <!-- æŠ˜ã‚Œç‚¹ -->
          <div class="box">
            <h3>æŠ˜ã‚Œç‚¹ï¼š[ãƒãƒ£ãƒ³ã‚¯]ï¼ˆåº§æ¨™ï¼‰</h3>
            <pre id="bendLocal"></pre>
            <a id="bendLink" class="link" target="_blank" rel="noopener">æŠ˜ã‚Œç‚¹ã‚’åœ°å›³ã§é–‹ã</a>
          </div>

          <!-- çµ‚ç‚¹å´ å‚¾ã -->
          <div class="box">
            <h3>çµ‚ç‚¹å´ã®å‚¾ã</h3>
            <pre id="slopeEnd"></pre>
          </div>

          <!-- çµ‚ç‚¹ -->
          <div class="box">
            <h3>çµ‚ç‚¹ï¼š[ãƒãƒ£ãƒ³ã‚¯]ï¼ˆåº§æ¨™ï¼‰</h3>
            <pre id="endLocal"></pre>
            <a id="endLink" class="link" target="_blank" rel="noopener">çµ‚ç‚¹ã‚’åœ°å›³ã§é–‹ã</a>
          </div>
        </div>

        <details class="details">
          <summary>ãƒ‡ãƒãƒƒã‚°è©³ç´°</summary>
          <pre id="debug"></pre>
          <button type="button" id="copyDebugBtn" class="primary">ğŸ“‹ ãƒ‡ãƒãƒƒã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>
        </details>
      </section>

    </div>
  </main>

  <!-- ===== å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ ===== -->
  <footer class="app-footer">
    <div class="container">
      <p class="muted">Â© wplaceæ²–ãƒé³¥å³¶é–‹ç™º æŠ€è¡“éƒ¨ãƒ»é“è·¯å…¬ç¤¾</p>
    </div>
  </footer>

  <!-- ===== ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ===== -->
  <script src="./utils.js"></script>
  <script>
    const form = document.getElementById('plan-form');
    const resultSec = document.getElementById('result');

    // å‚¾ãã®åˆ†æ•°è¡¨è¨˜å¯¾å¿œ
    const FRACTIONS = [
      [10,1],[9,1],[8,1],[7,1],[6,1],[5,1],[4,1],[3,1],[2,1],[1,1],
      [1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[1,8],[1,9],[1,10]
    ];
    function formatSlopeSigned(m) {
      if (!Number.isFinite(m)) return 'â€”';
      const sign = m < 0 ? '-' : '';
      const a = Math.abs(m);
      let best = FRACTIONS[0], bestErr = Math.abs(a - best[0]/best[1]);
      for (const [num, den] of FRACTIONS) {
        const err = Math.abs(a - num/den);
        if (err < bestErr) { bestErr = err; best = [num, den]; }
      }
      const [n, d] = best;
      const core = d === 1 ? `${n}` : `${n}/${d}`;
      return sign + core;
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const startUrl = document.getElementById('startUrlInput').value.trim();
      const endUrl   = document.getElementById('endUrlInput').value.trim();
      const order    = document.getElementById('order').value;

      try {
        const { lat: sLat, lng: sLng } = parseWplaceURL(startUrl);
        const { lat: eLat, lng: eLng } = parseWplaceURL(endUrl);

        const p1 = llzToWorldPixel(sLat, sLng);
        const p2 = llzToWorldPixel(eLat, eLng);

        const plan2 = planPolylineWorld(
          { x: p1.worldX, y: p1.worldY },
          { x: p2.worldX, y: p2.worldY },
          SLOPE_SET,
          { order, roundToInt: true }
        );

        // å§‹ç‚¹
        const s4k = toLocal(plan2.polylineWorld[0].x, plan2.polylineWorld[0].y, 4000);
        document.getElementById('startLocal').textContent =
          `[${s4k.chunkX}, ${s4k.chunkY}] (${s4k.x}, ${s4k.y})`;

        // æŠ˜ã‚Œç‚¹
        const b4k = plan2.bendLocal;
        document.getElementById('bendLocal').textContent =
          `[${b4k.chunkX}, ${b4k.chunkY}] (${b4k.x}, ${b4k.y})`;
        document.getElementById('bendLink').href =
          toWplaceURL(plan2.bend.x, plan2.bend.y, 18);

        // çµ‚ç‚¹
        const e4k = toLocal(plan2.plannedEnd.x, plan2.plannedEnd.y, 4000);
        document.getElementById('endLocal').textContent =
          `[${e4k.chunkX}, ${e4k.chunkY}] (${e4k.x}, ${e4k.y})`;
        document.getElementById('endLink').href =
          toWplaceURL(plan2.plannedEnd.x, plan2.plannedEnd.y, 18);

        // å‚¾ã
        const sPt = plan2.polylineWorld[0];
        const bPt = plan2.polylineWorld[1];
        const ePt = plan2.polylineWorld[2];
        const slopeStart = (bPt.x === sPt.x) ? Infinity : (bPt.y - sPt.y) / (bPt.x - sPt.x);
        const slopeEnd   = (ePt.x === bPt.x) ? Infinity : (ePt.y - bPt.y) / (ePt.x - bPt.x);

        document.getElementById('slopeStart').textContent = formatSlopeSigned(slopeStart);
        document.getElementById('slopeEnd').textContent   = formatSlopeSigned(slopeEnd);

        // ãƒ‡ãƒãƒƒã‚°
        document.getElementById('debug').textContent = JSON.stringify(plan2, null, 2);
        resultSec.hidden = false;
      } catch (err) {
        alert('URLã®è§£æã¾ãŸã¯è¨ˆç®—ã§ã‚¨ãƒ©ãƒ¼: ' + err.message);
        console.error(err);
      }
    });
  </script>
</body>
</html>
