<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>wplace æŠ˜ã‚Œç‚¹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <main class="container">
    <h1>wplace æŠ˜ã‚Œç‚¹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>

    <form id="plan-form" class="card">
      <div class="field">
        <label for="startUrlInput">å§‹ç‚¹URL</label>
        <input id="startUrlInput" name="startUrl" type="url"
               placeholder="https://wplace.live/?lat=...&lng=...&zoom=..." required />
      </div>

      <div class="field">
        <label for="endUrlInput">çµ‚ç‚¹äºˆå®šåœ°URL</label>
        <input id="endUrlInput" name="endUrl" type="url"
               placeholder="https://wplace.live/?lat=...&lng=...&zoom=..." required />
      </div>

      <div class="row">
        <div class="field">
          <label for="order">æŠ˜ã‚‹é †åº</label>
          <select id="order" name="order">
            <option value="auto" selected>è‡ªå‹•ï¼ˆèª¤å·®ãŒå°ã•ã„æ–¹ï¼‰</option>
            <option value="a-first">aå…ˆ â†’ b</option>
            <option value="b-first">bå…ˆ â†’ a</option>
          </select>
        </div>
      </div>

      <button type="submit" class="primary">è¨ˆç®—ã™ã‚‹</button>
      <p class="note">â€»URLã® <code>lat</code> ã¨ <code>lng</code> ã®ã¿å‚ç…§ã—ã¾ã™ã€‚</p>
    </form>

    <section id="result" class="card" hidden>
      <h2>çµæœ</h2>

      <div class="grid">
        <div class="box">
          <h3>å§‹ç‚¹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ï¼‰</h3>
          <pre id="startLocal"></pre>
        </div>

        <div class="box">
          <h3>æŠ˜ã‚Œç‚¹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ï¼‰</h3>
          <pre id="bendLocal"></pre>
          <a id="bendLink" class="link" target="_blank" rel="noopener">æŠ˜ã‚Œç‚¹ã‚’åœ°å›³ã§é–‹ã</a>
        </div>

        <div class="box">
          <h3>çµ‚ç‚¹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ï¼‰</h3>
          <pre id="endLocal"></pre>
          <a id="endLink" class="link" target="_blank" rel="noopener">çµ‚ç‚¹ã‚’åœ°å›³ã§é–‹ã</a>
        </div>
      </div>

      <div class="box" style="margin-top:12px;">
        <h3>èª¤å·®ï¼ˆplannedEnd âˆ’ ç›®æ¨™çµ‚ç‚¹, pxï¼‰</h3>
        <pre id="errorBox"></pre>
      </div>

      <details class="details">
        <summary>ãƒ‡ãƒãƒƒã‚°è©³ç´°</summary>
        <pre id="debug"></pre>
        <button type="button" id="copyDebugBtn" class="primary">ğŸ“‹ ãƒ‡ãƒãƒƒã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>
      </details>
    </section>

    <footer class="muted">Â© wplaceæ²–ãƒé³¥å³¶é–‹ç™º æŠ€è¡“éƒ¨ãƒ»é“è·¯å…¬ç¤¾</footer>
  </main>

  <script src="./utils.js"></script>
  <script>
    const form = document.getElementById('plan-form');
    const resultSec = document.getElementById('result');

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const startUrl = document.getElementById('startUrlInput').value.trim();
      const endUrl   = document.getElementById('endUrlInput').value.trim();
      const order    = document.getElementById('order').value;

      try {
        const { lat: sLat, lng: sLng } = parseWplaceURL(startUrl);
        const { lat: eLat, lng: eLng } = parseWplaceURL(endUrl);

        const p1 = llzToTilePixel(sLat, sLng, 4000);
        const p2 = llzToTilePixel(eLat, eLng, 4000);

        const plan2 = planPolylineWorld(
          { x: p1.worldX, y: p1.worldY },
          { x: p2.worldX, y: p2.worldY },
          SLOPE_SET,
          { order, roundToInt: true }
        );

        // â­ å§‹ç‚¹ï¼ˆ4000åŒºåˆ‡ã‚Šãƒãƒ£ãƒ³ã‚¯ + mod4000åº§æ¨™ï¼‰
        const s4k = toLocal(plan2.polylineWorld[0].x, plan2.polylineWorld[0].y, 4000);
        document.getElementById('startLocal').textContent =
        `[${s4k.chunkX}, ${s4k.chunkY}] (${s4k.x}, ${s4k.y})`;

        // â­ æŠ˜ã‚Œç‚¹
        const b4k = plan2.bendLocal;
        document.getElementById('bendLocal').textContent =
        `[${b4k.chunkX}, ${b4k.chunkY}] (${b4k.x}, ${b4k.y})`;
        document.getElementById('bendLink').href =
        toWplaceURL(plan2.bend.x, plan2.bend.y, 4000, 18);

        // â­ çµ‚ç‚¹
        const e4k = toLocal(plan2.plannedEnd.x, plan2.plannedEnd.y, 4000);
        document.getElementById('endLocal').textContent =
        `[${e4k.chunkX}, ${e4k.chunkY}] (${e4k.x}, ${e4k.y})`;
        document.getElementById('endLink').href =
        toWplaceURL(plan2.plannedEnd.x, plan2.plannedEnd.y, 4000, 18);

        // èª¤å·®
        const dx = Math.round(plan2.errorPx.dx);
        const dy = Math.round(plan2.errorPx.dy);
        const len = Math.hypot(dx, dy).toFixed(3);
        document.getElementById('errorBox').textContent =
          `dx = ${dx}\ndy = ${dy}\n|error| = ${len}`;

        document.getElementById('debug').textContent = JSON.stringify(plan2, null, 2);
        resultSec.hidden = false;
      } catch (err) {
        alert('URLã®è§£æã¾ãŸã¯è¨ˆç®—ã§ã‚¨ãƒ©ãƒ¼: ' + err.message);
        console.error(err);
      }
    });
  </script>
</body>
</html>
